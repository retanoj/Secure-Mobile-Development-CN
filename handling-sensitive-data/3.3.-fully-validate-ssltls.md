# 完全验证SSL/TLS

许多应用程序没有正确验证SSL / TLS证书，使其易受中间人（MITM）攻击。如果应用程序无法正确验证其与服务器的连接，则该应用程序易受特权网络攻击者的MITM攻击。这种类型的攻击使得劫持者能够捕获，查看和修改在应用程序和服务器之间发送和接收的流量。

## 细节

没有正确验证其与服务器的连接的应用程序容易受到特权网络攻击者的中间人攻击。这意味着攻击者将能够捕获，查看和修改在应用程序和服务器之间发送和接收的流量。

### _常见错误：接受自签名证书_

由于各种原因，开发人员可能会在应用程序中禁用证书验证。一个例子是开发人员需要测试生产服务器上的代码，但没有测试环境的域证书。在这种情况下，开发人员可能会设置接受所有证书为有效。然而，接受所有证书是有效的，将允许攻击者通过简单地使用自签名证书对应用程序执行MITM攻击。

这种设置会使SSL/TLS失去作用，并且提供了相当于未加密的明文连接（除了需要活动的MITM攻击以查看和修改流量，还可以被动地监视明文连接）。

以下是允许所有SSL / TLS证书有效的易受攻击的Android代码的示例：

```
 TrustManager[] trustAllCerts = new TrustManager[] {
    new X509TrustManager() {
       public java.security.cert.X509Certificate[] getAcceptedIssuers() {
         return null;
       }
       public void checkClientTrusted(X509Certificate[] certs, String authType) {  }

       public void checkServerTrusted(X509Certificate[] certs, String authType) {  }

    }
 };

 //Globally set the broken TrustManager
 SSLContext sc = SSLContext.getInstance("SSL");
 sc.init(null, trustAllCerts, new java.security.SecureRandom());
 HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());

 //Make the connection to the server
 URL url = new URL("https://paypal.com");
 HttpsURLConnection urlConnection = (HttpsURLConnection) url.openConnection();
 InputStream ins = urlConnection.getInputStream();
 InputStreamReader isr = new InputStreamReader(ins);
 BufferedReader in = new BufferedReader(isr);

 String inputLine;
 in.close();
```

### _常见错误：设置主机名白名单_ {#common-mistake-setting-a-permissive-hostname-verifier}

实施SSL / TLS的另一个常见的开发错误是设置一个主机名验证程序。在这种情况下，该应用程序将不会接受自签名证书，因为证书仍然被验证。但是，如果一个应用程序“允许所有主机名”，任何有效的证书颁发机构（CA）为任何域名颁发的证书可用于执行MITM攻击并签署流量。

以下是一个易受攻击的Android代码的例子，它设置了一个主机名验证白名单：

```
URL url = new URL("https://paypal.com");
HttpsURLConnection urlConnection = (HttpsURLConnection) url.openConnection();
urlConnection.setHostnameVerifier(SSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER);
InputStream ins = urlConnection.getInputStream();
InputStreamReader isr = new InputStreamReader(ins);
BufferedReader in = new BufferedReader(isr);

String inputLine;
in.close();
```









